<%page expression_filter="h"/>
<%! from django.utils.translation import ugettext as _ %>
<%namespace name='static' file='../static_content.html'/>

<style type="text/css">
  .helpdesk-widget {
    margin: 0;
    padding: 0;
    box-sizing: border-box;

    user-select: none;
    transition: .25s;
    font-family: "Open Sans","Helvetica Neue",Helvetica,Arial,sans-serif;

    right: 15px;
    bottom: 15px;
    position: fixed;
    z-index: 11;
  }

  .helpdesk-widget h3, .helpdesk-widget h2 {
    font-family: "Open Sans","Helvetica Neue",Helvetica,Arial,sans-serif;
  }

  .helpdesk-widget h3 {
    margin-bottom: 10px;
  }

  .helpdesk-widget form {
    height: 260px;
    padding: 10px 20px;
    position: relative;
    z-index: 100;
  }

  .helpdesk-widget select {
    margin-bottom: 10px;
  }

  #helpdesk-inner-frame {
    width: 350px;
    height: 300px;
    border-radius: 5px;
    border-bottom-right-radius: 30px;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(115,115,115,0.75);
    background-color: #fff;
  }

  .helpdesk-widget .header-line {
    height: 15px;
    padding: 11px;
    background-color: #01306E;
    font-weight: bold;
    color: #eee;
    display: grid;
    grid-template-columns: 1fr 60px;
  }

  .helpdesk-widget #step-2 > span {
    padding: 5px;
    font-size: 12px;
    color: #666;
  }
  .helpdesk-widget #step-2 > input {
    margin-top: 4px;
  }

  .helpdesk-widget .input-list-selection, .helpdesk-widget .input-text, .helpdesk-widget #textarea-body {
    font-size: 14px;
    line-height: 1.4;
    color: #555;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 4px;

    -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
    box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
    -webkit-transition: border-color ease-in-out .15s;
    -o-transition: border-color ease-in-out .15s;
    transition: border-color ease-in-out .15s;
  }

  .helpdesk-widget .input-list-selection {
    width: 100%;
    color: #757575;
    display: block;
    height: 34px;
    padding: 6px 12px;
  }
  .helpdesk-widget .input-list-selection:focus {
    border-color: #66afe9;
  }
  .helpdesk-widget .input-list-selection > option {
    color: #333;
  }

  .helpdesk-widget .input-text, .helpdesk-widget #textarea-body {
    user-select: text;
  }

  .helpdesk-widget .input-text {
    width: 100%;
    height: 30px;
    padding: 5px;
  }
  .helpdesk-widget .input-text:focus {
    border-color: #66afe9;
  }

  .helpdesk-widget #textarea-body {
    width: 100%;
    height: 100px;
    resize: none;
    display: block;
    padding: 6px 12px;
  }

  .helpdesk-widget .next-button {
    width: 100px;
    height: 30px;
    font-size: 14px;
    color: rgb(162, 205, 244);
    border: none;
    padding: 0;
    box-shadow: 0 0 5px rgba(115,115,115,0.75);
    background: rgb(1, 48, 110);

    left: 20px;
    bottom: 40px;
    position: absolute;
  }

  .helpdesk-widget .next-button:hover {
    background-color: #174d92;
    transition: .15s;
  }

  .helpdesk-widget #step-3 {
    color: #05336E;
    padding-top: 60px;
    text-align: center;
  }

  .helpdesk-widget #open-widget-btn {
    width: 60px;
    height: 60px;
    right: 15px;
    bottom: 15px;
    border-radius: 50%;
    background: #05336E url('/static/images/logo.png') 43% 50% no-repeat;
    background-size: 240px;
    box-shadow: 0 0 5px rgba(115,115,115,0.75);
    position: fixed;
    z-index: 100;
  }
</style>

<script type="text/javascript">
    const format_body = function() {
        let data = {
            "queue": document.getElementsByClassName("input-list-selection")[0].value,
            "title": document.getElementsByClassName("input-text")[0].value,
            "attachment": "",
            "body": document.getElementById("textarea-body").value,
            "priority": document.getElementsByClassName("input-list-selection")[1].value,
            "due_date": "",
            "submitter_email": document.getElementsByClassName("input-text")[1].value,
            "csrfmiddlewaretoken": "${csrf_token}",
        }

        const formData = new FormData();

        for (const name in data) {
            formData.append(name, data[name]);
        }

        return formData;
    }

    const send_request = function() {
        fetch("/helpdesk/", {
            "credentials": "include",
            "referrer": "/helpdesk/",
            "referrerPolicy": "no-referrer-when-downgrade",
            "body": format_body(),
            "method": "POST",
            "mode": "cors"
        });
    }

    d = document;
    d.Id = d.getElementById;
    d.Name = d.getElementsByClassName;
    d.addEventListener("DOMContentLoaded", function(event) {
        d.Id('open-widget-btn').onclick = function() {
            if (d.Id('helpdesk-inner-frame').style.display == "none") {
                d.Id('helpdesk-inner-frame').style.display = d.Id('next-btn-id').style.display = "block";
                d.Id('steps-indicator').innerHTML = "1 of 3";
            } else {
                d.Id('step-1').style.display = "block";
                d.Id('helpdesk-inner-frame').style.display = d.Id('step-2').style.display =
                d.Id('step-3').style.display = "none";
            }
        }

        let red_color = "rgb(153, 22, 22)";
        let blue_color = "rgb(22, 95, 153)";
        let red_shadow = "inset 0 1px 1px rgba(0,0,0,.075),0 0 8px rgba(153, 22, 22,.6)";
        let blue_shadow = "inset 0 1px 1px rgba(0,0,0,.075),0 0 8px rgba(102,175,233,.6)";

        d.Id('next-btn-id').onclick = function() {
            if(!d.Id("select_type").value.trim()){
              d.Id("select_type").style.borderColor = red_color; d.Id("select_type").style.boxShadow = red_shadow;
              return;
            }
            else {
              d.Id("select_type").style.borderColor = blue_color; d.Id("select_type").style.boxShadow = blue_shadow;
            }
            if(!d.Id("textarea-body").value.trim()){
              d.Id("textarea-body").style.borderColor = red_color; d.Id("textarea-body").style.boxShadow = red_shadow;
              return;
            }
            else {
              d.Id("textarea-body").style.borderColor = blue_color; d.Id("textarea-body").style.boxShadow = blue_shadow;
            }

            if (d.Id('step-1').style.display != "none") {
                d.Id('step-1').style.display = "none"; d.Id('step-2').style.display = "block";
                d.Id('steps-indicator').innerHTML = "2 of 3";
            } else if (d.Id('step-2').style.display == "block") {
              if(!d.Id("select_priority").value.trim()){
                d.Id("select_priority").style.borderColor = red_color; d.Id("select_priority").style.boxShadow = red_shadow;
                return;
              }
              else {
                d.Id("select_priority").style.borderColor = blue_color; d.Id("select_priority").style.boxShadow = blue_shadow;
              }
              if(!d.Id("summary").value.trim()){
                d.Id("summary").style.borderColor = red_color; d.Id("summary").style.boxShadow = red_shadow;
                return;
              }
              else {
                d.Id("summary").style.borderColor = blue_color; d.Id("summary").style.boxShadow = blue_shadow;
              }
              if(!d.Id("email").value.trim()){
                d.Id("email").style.borderColor = red_color; d.Id("email").style.boxShadow = red_shadow;
                return;
              }
              else {
                d.Id("email").style.borderColor = blue_color; d.Id("email").style.boxShadow = blue_shadow;
              }

              if (!d.Name("input-text")[0].value.trim() || !d.Name("input-text")[1].value.trim() ||
                  !d.Name("input-list-selection")[1].value) {
                  return
              }
              d.Id('step-3').style.display = "block";
              d.Id('step-2').style.display = d.Id('next-btn-id').style.display = "none";
              d.Id('steps-indicator').innerHTML = "3 of 3";

              send_request();
            }
        }
    })
</script>

<div class="helpdesk-widget">
  <div id="helpdesk-inner-frame" style="display: none">
    <div class="header-line"><p>${_('Helpdesk')}</p><span id="steps-indicator">${_('1 of 3')}</span></div>
    <form>
      <div id="step-1">
        <h3>${_('Create Ticket')}</h3>
        <select class="input-list-selection" id="select_type">
          <option value="">${_('Queue')}</option>
          <option value="1">${_('While taking course')}</option>
          <option value="2">${_('While creating course')}</option>
          <option value="3">${_('Technical problems')}</option>
        </select>
        <textarea id="textarea-body" placeholder="${_('Problem description')}"></textarea>
      </div>

      <div id="step-2" style="display: none">
        <h3>${_('Create Ticket')}</h3>
        <select class="input-list-selection" id="select_priority">
          <option value="">${_('Priority')}</option>
          <option value="1">${_('1. Critical')}</option>
          <option value="2">${_('2. High')}</option>
          <option value="3">${_('3. Normal')}</option>
          <option value="4">${_('4. Low')}</option>
          <option value="5">${_('5. Very Low')}</option>
        </select>
        <input class="input-text" id="summary" type="text" placeholder="${_('Got an 403 error')}">
        <span>${_('Summary of the problem')}</span>
        <input class="input-text" id="email" type="text" placeholder="example@domain.com">
        <span>${_('E-Mail') }</span>
      </div>

      <div id="step-3" style="display: none">
        <h2>${_('Complete! We started processig your ticket')}</h2>
      </div>

      <button class="next-button" id="next-btn-id" type="button">${_('Next')}</button>
    </form>
  </div>
  <div id="open-widget-btn"></div>
</div>
